<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Prevent iPad zoom + app-like feel -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="light" />
  <title>TalkBoard 90s</title>

  <!-- iOS Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#008080" />

  <style>
    :root{
      --teal:#008080;
      --win:#c0c0c0;
      --win2:#dcdcdc;
      --dark:#404040;
      --darker:#202020;
      --shadow:#808080;
      --light:#ffffff;
      --text:#000000;
      --navy:#000080;
      --navy2:#0000d0;
      --aqua:#00ffff;
      --aqua2:#00c0c0;
      --maroon:#800000;
      --pink:#ffb3b3;
      --led:#39ff14;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--teal);
      color: var(--text);
      font-family: "MS Sans Serif", Tahoma, Verdana, Arial, sans-serif;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    *{
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    /* Reduce double-tap zoom + callouts */
    button, select, input, textarea, .display {
      touch-action: manipulation;
      -webkit-touch-callout: none;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }

    .window{
      background: var(--win);
      border: 2px solid var(--dark);
      box-shadow: inset 2px 2px 0 var(--light), inset -2px -2px 0 var(--shadow);
      overflow: hidden;
    }

    .titlebar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      background: linear-gradient(90deg, var(--navy) 0%, #0000a8 55%, var(--navy2) 100%);
      color: #fff;
      font-weight: 900;
      user-select:none;
    }

    .title-left{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .marquee{
      width: min(760px, 74vw);
      overflow: hidden;
      white-space: nowrap;
      border: 2px solid #000;
      box-shadow: inset 2px 2px 0 rgba(255,255,255,.35), inset -2px -2px 0 rgba(0,0,0,.35);
      background: repeating-linear-gradient(90deg,#001400 0px,#001400 10px,#001900 10px,#001900 20px);
      color: var(--led);
      padding: 6px 10px;
      font-family: "Courier New", Courier, monospace;
      font-weight: 900;
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(57,255,20,.35);
      line-height: 1.1;
    }
    .marquee span{
      display:inline-block;
      padding-left:100%;
      animation: scroll 11s linear infinite;
    }
    @keyframes scroll{ from{transform:translateX(0)} to{transform:translateX(-100%)} }

    .titlebar .right{ display:flex; gap:6px; }
    .tb-btn{
      width: 18px; height: 18px;
      background: var(--win2);
      border: 2px solid var(--dark);
      box-shadow: inset 1px 1px 0 var(--light), inset -1px -1px 0 var(--shadow);
    }

    .content{
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 900px){
      .content{ grid-template-columns: 1.35fr .65fr; }
    }

    .panel{
      background: var(--win2);
      border: 2px solid var(--dark);
      box-shadow: inset 2px 2px 0 var(--light), inset -2px -2px 0 var(--shadow);
      padding: 10px;
    }

    .panel h3{
      margin:0 0 8px 0;
      font-size: 14px;
      font-weight: 900;
    }

    .display{
      background: #ffffff;
      border: 2px solid var(--darker);
      box-shadow: inset 2px 2px 0 var(--shadow), inset -2px -2px 0 var(--light);
      padding: 10px;
      min-height: 120px;
    }

    .text{
      font-size: 28px;
      line-height: 1.25;
      white-space: pre-wrap;
      word-break: break-word;
      user-select: text;
      -webkit-user-select: text;
    }

    .statusbar{
      margin-top: 8px;
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-weight: 800;
    }

    .toolbar{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .toolbar button{ flex: 1; min-width: 120px; }

    .phrases{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    @media (min-width: 900px){
      .phrases{ grid-template-columns: repeat(3, 1fr); }
    }

    button{
      appearance: none;
      -webkit-appearance: none;
      background: var(--win);
      color: var(--text);
      border: 2px solid var(--dark);
      box-shadow: inset 2px 2px 0 var(--light), inset -2px -2px 0 var(--shadow);
      border-radius: 0;
      padding: 12px 10px;
      font-family: inherit;
      font-weight: 900;
      cursor: pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    button:active{
      box-shadow: inset -2px -2px 0 var(--light), inset 2px 2px 0 var(--shadow);
      transform: translateY(1px);
    }

    .big{ padding: 14px 12px; font-size: 16px; }

    .primary{
      background: linear-gradient(180deg, var(--aqua), var(--aqua2));
      border-color: #005f5f;
    }
    .danger{
      background: linear-gradient(180deg, var(--pink), #ff8080);
      border-color: var(--maroon);
    }
    .ghost{ background: var(--win2); }

    #speakBtn{
      font-size: 18px;
      padding: 18px 14px;
      border-width: 3px;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: inset 3px 3px 0 var(--light), inset -3px -3px 0 var(--shadow), 0 0 0 2px #000;
    }

    label{ font-size: 12px; font-weight: 900; }

    select, textarea{
      width: 100%;
      padding: 10px 10px;
      font-family: inherit;
      font-weight: 900;
      border-radius: 0;
      border: 2px solid var(--darker);
      box-shadow: inset 2px 2px 0 var(--shadow), inset -2px -2px 0 var(--light);
      background: #ffffff;
      color: var(--text);
    }

    textarea{
      min-height: 84px;
      resize: vertical;
      -webkit-user-select: text;
      user-select: text;
    }

    input[type="range"]{ width: 100%; }

    .fieldrow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    .hint{
      font-size: 12px;
      margin-top: 8px;
      padding: 8px;
      background: #ffffff;
      border: 2px solid var(--darker);
      box-shadow: inset 2px 2px 0 var(--shadow), inset -2px -2px 0 var(--light);
      font-weight: 800;
    }

    .tiny{ font-size: 12px; font-weight: 900; }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="window" role="application" aria-label="TalkBoard 90s">
      <div class="titlebar">
        <div class="title-left">
          <div>TalkBoard 90s</div>
          <div class="marquee" aria-hidden="true">
            <span> TYPE WITH YOUR iPAD KEYBOARD • PRESS SPEAK • RETRO MODE • </span>
          </div>
        </div>
        <div class="right" aria-hidden="true">
          <div class="tb-btn"></div><div class="tb-btn"></div><div class="tb-btn"></div>
        </div>
      </div>

      <div class="content">
        <!-- LEFT -->
        <section class="panel">
          <h3>Message</h3>
          <div class="display">
            <div id="output" class="text" aria-live="polite"> </div>
          </div>

          <div class="statusbar">
            <div class="tiny">Status: <span id="status">Ready</span></div>
            <div class="tiny">Autosave: On</div>
          </div>

          <div class="fieldrow">
            <label for="editor">Type here (iPad / Magic Keyboard works)</label>
            <textarea id="editor" placeholder="Type your message here..."></textarea>
          </div>

          <div class="toolbar">
            <!-- IMPORTANT: Speak uses CLICK (most reliable for iOS speech) -->
            <button id="speakBtn" class="primary big">Speak</button>
            <button id="pauseBtn" class="ghost big">Pause</button>
            <button id="stopBtn"  class="ghost big">Stop</button>
            <button id="clearBtn" class="danger big">Clear</button>
          </div>

          <div style="height:12px"></div>

          <div class="panel" style="background: var(--win) !important;">
            <h3>Quick Phrases</h3>
            <div id="quickPhrases" class="phrases"></div>
          </div>

          <div class="hint">
            If speech doesn’t start: open this site in <b>Safari</b> (not inside GitHub), then tap Speak again.
          </div>
        </section>

        <!-- RIGHT -->
        <aside class="panel">
          <h3>Voice</h3>

          <div class="fieldrow">
            <label for="voiceSel">Voice</label>
            <select id="voiceSel"></select>
          </div>

          <div class="fieldrow">
            <label for="rate">Rate</label>
            <input id="rate" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
          </div>

          <div class="fieldrow">
            <label for="pitch">Pitch</label>
            <input id="pitch" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
          </div>

          <div class="hint">
            iPad: Safari → Share → <b>Add to Home Screen</b> for app-like mode.
          </div>
        </aside>
      </div>
    </div>
  </div>

<script>
(() => {
  const output   = document.getElementById("output");
  const statusEl = document.getElementById("status");
  const editor   = document.getElementById("editor");

  const speakBtn = document.getElementById("speakBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const clearBtn = document.getElementById("clearBtn");

  const quickEl  = document.getElementById("quickPhrases");

  const voiceSel = document.getElementById("voiceSel");
  const rateEl   = document.getElementById("rate");
  const pitchEl  = document.getElementById("pitch");

  // ---------- Status ----------
  function status(t){ statusEl.textContent = t; }

  // ---------- iOS-safe Beep (single AudioContext) ----------
  let audioCtx = null;
  function initAudio(){
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;
    if (!audioCtx) audioCtx = new AudioCtx();
    if (audioCtx.state === "suspended") audioCtx.resume();
  }
  function beep(){
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.value = 880;
    g.gain.value = 0.04;
    o.connect(g); g.connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    o.start(t);
    o.stop(t + 0.07);
  }
  document.addEventListener("click", initAudio, { once: true });

  // ---------- State + Autosave ----------
  function setText(t){
    editor.value = t;
    output.textContent = t || " ";
    localStorage.setItem("talkboard90_text", t);
  }
  function getText(){
    return editor.value || "";
  }

  // Keep display synced with textarea (hardware keyboard friendly)
  editor.addEventListener("input", () => {
    output.textContent = editor.value || " ";
    localStorage.setItem("talkboard90_text", editor.value || "");
  });

  // ---------- Quick phrases ----------
  const quick = [
    "Hello", "Yes", "No", "Thank you", "Please",
    "I need help", "I’m thirsty", "I’m hungry", "I’m in pain",
    "I need the toilet", "Stop please", "Goodbye"
  ];

  function insertPhrase(p){
    const cur = getText();
    const next = cur && !cur.endsWith(" ") && !cur.endsWith("\n") ? (cur + " " + p) : (cur + p);
    setText(next);
    editor.focus();
  }

  function makeBtn(label, fn, cls="ghost"){
    const b = document.createElement("button");
    b.className = cls;
    b.textContent = label;
    b.addEventListener("click", () => { initAudio(); beep(); fn(); });
    return b;
  }

  function renderQuick(){
    quickEl.innerHTML = "";
    quick.forEach(p => quickEl.appendChild(makeBtn(p, () => insertPhrase(p), "ghost")));
  }

  // ---------- Speech (iPad reliable) ----------
  let voices = [];

  function loadVoices(){
    voices = ("speechSynthesis" in window) ? speechSynthesis.getVoices() : [];
    voiceSel.innerHTML = "";

    if (!voices || voices.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Default voice";
      voiceSel.appendChild(opt);
      return;
    }

    voices.forEach((v, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSel.appendChild(opt);
    });

    const en = voices.findIndex(v => (v.lang || "").toLowerCase().startsWith("en"));
    if (en >= 0) voiceSel.value = String(en);
  }

  function speakNow(){
    if (!("speechSynthesis" in window)){
      status("Speech not supported (use Safari).");
      alert("Speech not supported in this browser. Use Safari on iPad.");
      return;
    }

    const msg = getText().trim();
    if (!msg){ status("Nothing to speak"); return; }

    // iOS Safari reliability steps
    speechSynthesis.resume();
    speechSynthesis.cancel();

    // Ensure voices loaded (iOS sometimes empty at first)
    if (!voices || voices.length === 0) loadVoices();

    const u = new SpeechSynthesisUtterance(msg);
    u.rate  = Number(rateEl.value);
    u.pitch = Number(pitchEl.value);

    const idx = parseInt(voiceSel.value, 10);
    if (!isNaN(idx) && voices && voices[idx]) u.voice = voices[idx];

    u.onstart = () => status("Speaking…");
    u.onend   = () => status("Ready");
    u.onerror = () => status("Speech error (try reload / Safari)");

    // Tiny delay after cancel helps iOS
    setTimeout(() => speechSynthesis.speak(u), 80);
  }

  function pauseResume(){
    if (!("speechSynthesis" in window)) return;

    if (speechSynthesis.speaking && !speechSynthesis.paused){
      speechSynthesis.pause();
      pauseBtn.textContent = "Resume";
      status("Paused");
    } else if (speechSynthesis.paused){
      speechSynthesis.resume();
      pauseBtn.textContent = "Pause";
      status("Speaking…");
    }
  }

  function stop(){
    if (!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    pauseBtn.textContent = "Pause";
    status("Stopped");
  }

  // IMPORTANT: Speak uses CLICK, no preventDefault
  speakBtn.addEventListener("click", () => { initAudio(); beep(); speakNow(); });
  pauseBtn.addEventListener("click", () => { initAudio(); beep(); pauseResume(); });
  stopBtn.addEventListener("click",  () => { initAudio(); beep(); stop(); });

  clearBtn.addEventListener("click", () => {
    initAudio(); beep();
    setText("");
    status("Cleared");
    stop();
    editor.focus();
  });

  // ---------- Init ----------
  setText(localStorage.getItem("talkboard90_text") || "");
  renderQuick();
  loadVoices();
  if ("speechSynthesis" in window) speechSynthesis.onvoiceschanged = loadVoices;

  // Start focused for typing
  setTimeout(() => editor.focus(), 120);
  status("Ready");
})();
</script>
</body>
</html>
